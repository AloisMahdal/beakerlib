$yum_config_stanza
# End yum configuration
$SNIPPET('post_install_kernel_options')
$SNIPPET('post_install_network_config')
$SNIPPET('func_register_if_enabled')
$SNIPPET('download_config_files')
$SNIPPET('koan_environment')
$SNIPPET('redhat_register')
# Enable post-install boot notification
$SNIPPET('post_anamon')

#if $getVar('grubport','') != ''
/bin/sed -i 's/^serial.*/serial --port=$grubport --speed=115200/' /boot/grub/grub.conf
#end if

#if $getVar('arch','') == 'ia64'
BOOT=\$(/usr/sbin/efibootmgr -v | grep BootOrder | awk '{print $2}' | awk -F, '{print $1}')
EFI=\$(/usr/sbin/efibootmgr -v | grep Boot$BOOT | awk '{print $NF}')
PXE_SLOT=\$(/usr/sbin/efibootmgr -v | grep -i Netboot |cut -c5-8)
#
# If There is no Netboot Entry we can't continue
# You have to manually setup a Netboot entry first
# from EFI maint menu.
#
if [ ! -z $PXE_SLOT ]; then
   NEWBOOT=\$(echo $BOOT| sed -e 's/$PXE_SLOT,//')
   # its cheesy. but it works.
   NEWBOOT=\$(echo $NEWBOOT| sed -e 's/,$PXE_SLOT,//')
   NEWBOOT=\$(echo $NEWBOOT| sed -e 's/,$PXE_SLOT//')
   /usr/sbin/efibootmgr -o $PXE_SLOT,$NEWBOOT
   /usr/sbin/efibootmgr -n $BOOT
fi
#end if

#set $yum = $getVar("yum","")
#if $yum == ""
    #if $os_version == "rhel3"
        #set $yum = "yum-2.2.2-1.rhts.EL3.noarch.rpm"
    #end if
    #if $os_version == "rhel4"
        #set $yum = "yum-2.2.2-1.rhts.EL4.noarch.rpm"
    #end if
#end if

#if $yum != ""
# Install Yum
pushd /root
/usr/bin/wget -N http://$server/rpms/$yum
/bin/rpm -Uvh $yum
popd
#end if

# Add Distro Repos
PIFS=$IFS
IFS=":"
set -- $tree_repos
let count=1
for repo in $*; do
    cat << EOF >>/etc/yum.repos.d/distro.repo
[distro$count]
name=distro$count
baseurl=http://$server/distros$repo
enabled=1
gpgcheck=0

EOF
let count+=1
done
IFS=$PIPFS

#if $getVar('rhts_server','') != ''
# Add RHTS Test Repo
cat << EOF > /etc/yum.repos.d/rhts-tests.repo
[rhts-tests]
name=rhts tests $testrepo
baseurl=http://$rhts_server/rpms/$testrepo/noarch/noarch
enabled=1
gpgcheck=0

EOF

PIFS=$IFS
IFS="|"
set -- $customrepos
let count=1
for repo in $*; do
    cat << EOF >>/etc/yum.repos.d/rhts-custom.repo
[rhts-custom$count]
name=rhts-custom$count
baseurl=$repo
enabled=1
gpgcheck=0

EOF
let count+=1
done
IFS=$PIPFS

# Install RHTS RPMS
yum -y install rhts-test-env-lab rhts-legacy
yum -y install yum-utils

# Get the RHTS job
wget -O /mnt/tests/runtests.sh http://$rhts_server/testlogs/recipes/$recipeid/runtests.sh
chmod 755 /mnt/tests/runtests.sh
#end if
$kickstart_done
